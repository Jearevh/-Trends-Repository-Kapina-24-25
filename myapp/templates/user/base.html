{% load static %}
<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Kapina{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'user/base.css' %}">
    <link rel="stylesheet" href="{% static 'user/landing.css' %}">
    <link rel="stylesheet" href="{% static 'user/add_product.css' %}">
    <link rel="stylesheet" href="{% static 'user/business_profile.css' %}">
    <link rel="stylesheet" href="{% static 'user/shop_page.css' %}">
    <link rel="stylesheet" href="{% static 'user/shop_detail.css' %}">
    <link rel="stylesheet" href="{% static 'user/users.css' %}">
    <link rel="stylesheet" href="{% static 'user/inventory.css' %}">
    <link rel="stylesheet" href="{% static 'user/auth.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Header Section -->
    <div class="header">
        <div class="header-content">
            <a href="{% url 'landing' %}" class="logo">
                <img src="{% static 'images/KapinaLogo.png' %}" alt="Kapina Logo">
            </a>
        </div>

        <div class="search-container">
            <div class="search-left">
                <label class="search-label">Where</label>
                <input type="text" id="locationSearchInput" placeholder="Search Coffee Shops" class="search-input">
            </div>
            <div class="search-divider"></div>
            <div class="search-right">
                <label class="search-label">Drink</label>
                <input type="text" id="drinkSearchInput" placeholder="Find your taste" class="search-input">
            </div>
            
            <button class="search-btn" onclick="performSearch()">
                <i class="fas fa-search"></i>
            </button>
        </div>

        {% if not user.is_authenticated or not user.businessprofile %}
            <a href="{% url 'create_business_profile' %}" class="partner-link">Partner with Kapina</a>
        {% endif %}

        <div class="profile-container">
            <div class="profile-btn" onclick="toggleDropdown(event)">
                <i class="fas fa-user-circle"></i>
            </div>            
            <div class="profile-dropdown" id="profileDropdown">
                {% if user.is_authenticated %}
                    {% if user.is_superuser %}
                        <a href="{% url 'inventory' %}" class="dropdown-item">Inventory</a>
                        <a href="{% url 'addproduct' %}" class="dropdown-item">Add Product</a>
                        <a href="{% url 'users' %}" class="dropdown-item">Manage Users</a>
                        <form method="post" action="{% url 'logout' %}" class="dropdown-item">
                            {% csrf_token %}
                            <button type="submit">Logout</button>
                        </form>
                    {% elif user.businessprofile %}
                        <a href="{% url 'shop_page' %}" class="dropdown-item">Switch to Business Profile</a>
                        <form method="post" action="{% url 'logout' %}" class="dropdown-item">
                            {% csrf_token %}
                            <button type="submit">Logout</button>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'logout' %}" class="dropdown-item">
                            {% csrf_token %}
                            <button type="submit">Logout</button>
                        </form>
                    {% endif %}
                {% else %}
                    <a href="{% url 'login' %}" class="dropdown-item">Login to your account</a>
                    <a href="{% url 'register' %}" class="dropdown-item">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="header-divider"></div>

    <!-- Page Specific Content -->
    {% block content %}{% endblock %}

    <!-- Footer Section -->
    <div class="footer">
        <div class="footer-content">
            <a href="#" class="footer-links">Contact</a>
            <a href="#" class="footer-links">About Us</a>
            <a href="#" class="footer-links">Terms of Privacy</a>
        </div>
    </div>

    <script>
    function toggleDropdown(event) {
        event.stopPropagation();
        console.log('Profile button clicked');
        const dropdown = document.getElementById('profileDropdown');
        const displayStyle = window.getComputedStyle(dropdown).display;
        console.log('Current display: ', displayStyle);

        if (displayStyle === 'block') {
            dropdown.style.display = 'none';
            console.log('Hiding dropdown');
        } else {
            dropdown.style.display = 'block';
            console.log('Showing dropdown');
        }
    }

    window.onclick = function(event) {
        const dropdown = document.getElementById('profileDropdown');
        if (!event.target.matches('.profile-btn') && !event.target.matches('.dropdown-item')) {
            if (window.getComputedStyle(dropdown).display === 'block') {
                dropdown.style.display = 'none';
                console.log('Closing dropdown when clicked outside');
            }
        }
    }

    // Search functionality
    const locationSearchInput = document.getElementById('locationSearchInput');
    const drinkSearchInput = document.getElementById('drinkSearchInput');
    let locationSearchTimeout;
    let drinkSearchTimeout;

    function performSearch() {
        const locationQuery = locationSearchInput.value.trim();
        const drinkQuery = drinkSearchInput.value.trim();

        if (locationQuery) {
            performLocationSearch(locationQuery);
        }
        if (drinkQuery) {
            performDrinkSearch(drinkQuery);
        }
    }

    locationSearchInput.addEventListener('input', function() {
        clearTimeout(locationSearchTimeout);
        const query = this.value.trim();
        if (query) {
            locationSearchTimeout = setTimeout(() => {
                performLocationSearch(query);
            }, 300);
        }
    });

    drinkSearchInput.addEventListener('input', function() {
        clearTimeout(drinkSearchTimeout);
        const query = this.value.trim();
        if (query) {
            drinkSearchTimeout = setTimeout(() => {
                performDrinkSearch(query);
            }, 300);
        }
    });

    function performLocationSearch(query) {
        console.log('Performing location search for:', query);
        const searchUrl = `/search/?q=${encodeURIComponent(query)}&type=where`;
        console.log('Location search URL:', searchUrl);

        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Location search data:', data);
                if (data.results && data.results.length > 0) {
                    displayLocationResults(data.results);
                } else {
                    // Clear the results if no matches found
                    const cardsContainer = document.querySelector('.cards-container');
                    if (cardsContainer) {
                        cardsContainer.innerHTML = '<p class="no-results">No locations found</p>';
                    }
                }
            })
            .catch(error => {
                console.error('Location search error:', error);
                const cardsContainer = document.querySelector('.cards-container');
                if (cardsContainer) {
                    cardsContainer.innerHTML = '<p class="error">Error searching locations</p>';
                }
            });
    }

    function performDrinkSearch(query) {
        console.log('Performing drink search for:', query);
        const searchUrl = `/search/?q=${encodeURIComponent(query)}&type=drink`;
        console.log('Drink search URL:', searchUrl);

        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Drink search data:', data);
                if (data.results && data.results.length > 0) {
                    displayDrinkResults(data.results);
                } else {
                    // Clear the results if no matches found
                    const cardsContainer = document.querySelector('.cards-container');
                    if (cardsContainer) {
                        cardsContainer.innerHTML = '<p class="no-results">No drinks found</p>';
                    }
                }
            })
            .catch(error => {
                console.error('Drink search error:', error);
                const cardsContainer = document.querySelector('.cards-container');
                if (cardsContainer) {
                    cardsContainer.innerHTML = '<p class="error">Error searching drinks</p>';
                }
            });
    }

    function displayLocationResults(shops) {
        const cardsContainer = document.querySelector('.cards-container');
        if (cardsContainer) {
            cardsContainer.innerHTML = shops.map(shop => `
                <div class="card">
                    <img src="${shop.image || '{% static "images/default-shop.jpg" %}'}" alt="${shop.name}">
                    <div class="card-header">
                        <h3 class="card-title">${shop.name}</h3>
                        <div class="card-location-hours">
                            <span class="card-address">${shop.address}</span>
                            <span class="separator"></span>
                            <span class="card-hours">8:00 am to 11:00pm</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    function displayDrinkResults(products) {
        const cardsContainer = document.querySelector('.cards-container');
        if (cardsContainer) {
            cardsContainer.innerHTML = products.map(product => `
                <div class="card">
                    <img src="${product.image || '{% static "images/default-product.jpg" %}'}" alt="${product.name}">
                    <div class="card-header">
                        <h3 class="card-title">${product.name}</h3>
                        <div class="card-location-hours">
                            <span class="card-address">${product.shop_name}</span>
                            <span class="separator"></span>
                            <span class="card-hours">â‚±${product.price}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }
    </script>
</body>
</html>
